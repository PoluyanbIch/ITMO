## Билет 7. Паросочетания с предпочтениями. Теорема Гэйла-Шепли.
> Иногда вершинам не всё равно, с какими вершинами “вступать в **паросочетание**”. 
> Предположим, что каждая вершина имеет **список предпочтений**, то есть, **упорядочивает** инцидентные ей рёбра. 
> Построим такое **паросочетание** $M$ (не обязательно максимальное), что в нём не будет ребра $e = ab$, которое обе вершины $a$ и $b$ **хотели бы поменять** на свободные рёбра. Дадим строгие определения

1) Пусть для каждой вершины $v \in V (G)$ задано **линейное отношение** (нестрогого) порядка $\leq_v$ **на множестве** всех инцидентных $v$ **рёбер** из $E(G)$. 
Тогда $≤ \ = \{≤_v \}_{v ∈V (G )}$ — **множество предпочтений**.
> Например, если у вершины $v$ есть рёбра $e_1$, $e_2$,$e_3$​, то она может сказать, что $e_1 \leq_v e_2 \leq_v e_3$​, где $e_1$​ **наименее предпочтительное** ребро, а $e_3$​ — **наиболее**

2) Паросочетание $M$ называется **стабильным** для множества предпочтений $\leq$, если **для любого ребра** $f \not\in M$ существует такое ребро $e \in M$, что $e$ и $f$ имеют **общий конец** $v$ и $f \leq_v e$.

> *Объяснение* $f \leq_v e$:  вершина $v$ **предпочитает** ребро $e$, уже включённое в паросочетание, ребру $f$, которого нет в паросочетании.

> Ни одно ребро $f \not\in M$ **не может "разрушить" стабильность**, потому что для вершины $v$, которая соединена с $f$, **уже существует ребро** $e \in M$, которое для этой вершины **лучше** (или равно по предпочтению), чем $f$, а значит ребро $f$ **не может быть включёно** в стабильное паросочетание.

### Stable marriage theorem (теорема о деревенских свадьбах)
**(D. Gale, L. Shapley, 1962.)** Пусть $G$ — **двудольный граф**. Тогда для любого множества предпочтений $\leq$ в графе $G$ существует **стабильное паросочетание**.

#### Доказательство
- Будем считать вершины **одной доли мужчинами**, а вершины **другой доли — женщинами**, а наше паросочетание будет состоять из семейных пар. **Изначально наше паросочетание пусто**, оно будет изменяться пошагово. 

*Опишем шаг алгоритма изменения паросочетания*.
- Сначала действуют **мужчины**:
каждый **неженатый** (то есть, не покрытый паросочетанием) **мужчина выбирает женщину**, которая ему больше всех нравится (то есть, наивысшую в своем предпочтении) из тех, **которым он еще не делал предложения** (если такие есть), после чего делает ей предложение.
- Затем действуют **женщины**:
каждая из них **рассматривает всех мужчин**, кто сделал ей предложение и нравится ей строго больше, чем ее муж (если он есть). Если это множество непусто, она **выбирает из них того, кто нравится ей больше всего** (если таких несколько, то любого из них) и выходит за него замуж (вместо ее прежнего мужа, если он был) ~~ш-общительная~~.
- Конечность алгоритма очевидна: никакой мужчина **не делает предложение одной женщине дважды**. Пусть в результате получилось паросочетнание $M$.

*Докажем, что* $M$ *стабильно*. 
- Рассмотрим любое ребро $uw \in E(G) \setminus M$ (где $u$ — мужчина).
- Если $u$ **делал предложение** $w$ , то 
	- либо $w$ ему **отказала**, 
	- либо сначала **приняла** предложение, но потом **бросила**, 
- Значит $w$ **нашла мужа** $u'$, который ей нравится **не меньше, чем** $u$ (то есть, существует ребро $u'w \in M$, для которого $uw \leq_w u'w$).
- Если же $u$ **не делал предложения** $w$ , то в процессе алгоритма **нашел жену** $w'$, которая нравится ему **не меньше, чем** $w$ (то есть, существует ребро $uw' \in M$, для которого $uw \leq_u uw'$).
- Таким образом, построеннное паросочетание **стабильно по определению**. 